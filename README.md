# Provenance-Aware Metadata (Phase 2)

This project demonstrates a general workflow for **provenance-aware metadata** on digital assets:
- **Model** metadata in **JSON-LD** (Dublin Core, PROV-O, Schema.org)
- **Validate** with **SHACL** (custom policy rules)
- **Sign** assets with **C2PA** (actions + rights)
- **Serve** via **FastAPI** and a **dynamic IIIF Presentation 3.0** manifest

---

## ‚ú® What‚Äôs new in Phase 2 (v0.2)

- **CLI**: single entry point (`src/cli.py`) for build / validate / sign / serve / info  
- **Auto-generation** of `record.jsonld` from `metadata/source.yml`  
- **Dynamic IIIF manifest** generated by the API from your JSON-LD  
- **API hardening**: `/image` now falls back to the unsigned asset if a signed one is not present  
- **CI** (example workflow) for SHACL validation on pushes/PRs  
- **Env-driven signing** (uses org cert/key **if provided**) with **safe fallback** to the tool‚Äôs dev signer  
- **Dockerized** app for easy run/deploy

---

## üóÇÔ∏è Repository Structure

```
data/                    # Input/output assets
  image.jpg              # Original image (committed or fetched at build)
  image.c2pa.jpg         # Signed image (generated)

metadata/
  source.yml             # Minimal source fields (Phase 2)
  record.jsonld          # Built JSON-LD (do not hand-edit)
  shacl.ttl              # SHACL shapes (policy rules)
  claim.json             # C2PA claim (actions + rights)

src/
  build_metadata.py      # Build JSON-LD from source.yml
  validate_metadata.py   # SHACL validation
  sign_c2pa.sh           # Signing (env-driven with dev fallback)
  api.py                 # FastAPI app (record, image, dynamic IIIF)
  cli.py                 # One CLI for build/validate/sign/serve/info

iiif/
  (optional in Phase 2; manifest is served dynamically)

.github/
  workflows/validate.yml # CI (optional; runs SHACL validation)

Makefile                 # make build | validate | sign | serve | info | all
requirements.txt         # runtime dependencies (container & bare metal)
environment.yml          # Conda environment (local dev)
Dockerfile               # Containerized API service
```

---

## üîß Setup

### A) Conda (local dev)
```bash
conda env create -f environment.yml
conda activate Provenance-Aware-Metadata
```

### B) Install `c2patool` (CLI)
Choose one:

**Prebuilt (recommended)**
```bash
# download release for your OS (e.g., v0.9.12), then:
sudo mv c2patool /usr/local/bin/
c2patool -V
```

**Cargo (pin version)**
```bash
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
source "$HOME/.cargo/env"
cargo install --locked c2patool --version 0.9.12
~/.cargo/bin/c2patool -V
```

---

## ‚ñ∂Ô∏è Run (Phase 2)

**0) Prepare image (optional)**  
```bash
mkdir -p data
wget -O data/image.jpg "https://upload.wikimedia.org/wikipedia/commons/e/ea/Leibniz_University_Hannover.jpg"
```

**1) Build JSON-LD from YAML**
```bash
python src/cli.py build
```

**2) Validate against SHACL**
```bash
python src/cli.py validate
# expect: Conforms: True
```

**3) Sign with C2PA**
- Default (dev signer; no secrets required)
```bash
python src/cli.py sign
# or: bash src/sign_c2pa.sh
```

- Prod-like (optional): use org cert/key if available
```bash
export C2PA_SIGN_CERT="certs/org.crt"
export C2PA_PRIVATE_KEY="certs/org.key"
python src/cli.py sign
```

**4) Serve API (record, image, IIIF)**
```bash
python src/cli.py serve
# http://127.0.0.1:8000/record
# http://127.0.0.1:8000/image
# http://127.0.0.1:8000/iiif/manifest
```

**Makefile shortcuts**
```bash
make build
make validate
make sign
make serve
# or everything except docker with:
make all
```

---

## üêã Docker

**Build**
```bash
docker build -t provenance-metadata:dev .
```

**Run**
```bash
# if image(s) baked into the container
docker run --rm -p 8000:8000 provenance-metadata:dev

# OR mount host data folder (to use your local signed file)
docker run --rm -p 8000:8000 -v "$(pwd)/data:/app/data" provenance-metadata:dev
```

---

## üöß CI (validation only)
An example GitHub Actions workflow runs **SHACL validation** on push/PR to keep metadata compliant.  
Enable it in `.github/workflows/validate.yml`, and ensure it targets your branches (e.g., `main`, `dev`).

---

## üöß Roadmap

- **Phase 1 (done)**  
  - Manual JSON-LD modeling  
  - SHACL validation  
  - C2PA signing with dev key  
  - Static IIIF manifest via FastAPI  

- **Phase 2 (done)**  
  - CLI workflow (build/validate/sign/serve/info)  
  - Auto-generate JSON-LD from YAML source  
  - Dynamic IIIF manifest in API  
  - CI validation on push/PR  
  - Env-driven signing with fallback  
  - Dockerized API  

- **Phase 3 (planned)**  
  - Integration with platforms (Europeana, Zenodo, ‚Ä¶)  
  - Broader metadata standards (PREMIS, EDM, IIIF Annotations)  
  - Secure key management for C2PA  

- **Phase 4 (planned)**  
  - Packaged Docker deployment (prod-ready)  
  - Open APIs & example datasets

---

## üìú License
- Code: MIT  
- Image: *Leibniz University Hannover* (CC BY-SA 3.0), from [Wikimedia Commons](https://commons.wikimedia.org/wiki/File:Leibniz_University_Hannover.jpg).

---

## üîñ Versioning
- **v0.1** ‚Äî Manual prototype (metadata, SHACL, C2PA, static IIIF).  
- **v0.2** ‚Äî Automation & containerization (CLI, YAML‚ÜíJSON-LD, dynamic IIIF, API fallback, CI, Docker, env-driven signing).
